package xmlPushpa;

import java.io.File;
import java.io.IOException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import org.apache.log4j.FileAppender;
import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.apache.log4j.PatternLayout;
import org.apache.log4j.RollingFileAppender;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

public class XmlRemove {

	static Logger logger = Logger.getLogger(XmlRemove.class.getName());
	private static String INPUT_FILE_NAME = "MyLogs.log";

	private static final String OUTPUT_XML = "output.xml";
	private static final String INPUT_XML = "input.xml";
	private static final String CONF_ITEM = "CONF-ITEM";
	private static final String DSM = "dsm";
	private static final String SHORT_NAME = "SHORT-NAME";

	public static void main(String[] args) throws XPathExpressionException {
		initializeLogger(INPUT_FILE_NAME);
		logger.info("Entering main method");
		File xmlfile = new File(INPUT_XML);
		DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
		DocumentBuilder dBuilder;
		if (!xmlfile.exists()) {
			logger.info("*********** Xml file not found. Exiting program **************");
			return;
		}
		try {
			dBuilder = dbFactory.newDocumentBuilder();
			Document doc = dBuilder.parse(xmlfile);

			logger.info("xml parsing completed.");
			while (deleteElement(doc)) {

			}
			logger.info("deleting the CONF_ITEM completed.");
			doc.getDocumentElement().normalize();

			XPath xp = XPathFactory.newInstance().newXPath();
			NodeList nl = (NodeList) xp.evaluate("//text()[normalize-space(.)='']", doc, XPathConstants.NODESET);

			for (int i = 0; i < nl.getLength(); ++i) {
				Node node = nl.item(i);
				node.getParentNode().removeChild(node);
			}
			logger.info("Removed the blank/empty lines in the output xml.");

			TransformerFactory transformerFactory = TransformerFactory.newInstance();
			Transformer transformer = transformerFactory.newTransformer();
			DOMSource source = new DOMSource(doc);
			StreamResult result = new StreamResult(new File(OUTPUT_XML));
			transformer.setOutputProperty(OutputKeys.INDENT, "yes");
			transformer.transform(source, result);
			logger.info("writing to output xml file success.");
			System.out.println(0);
		} catch (Exception e1) {
			logger.info("Exception occured while removing the xml element.");
			e1.printStackTrace();
			System.out.println(1);
		}
		logger.info("Exit main method");
	}

	private static boolean deleteElement(Document doc) {
		logger.info("Entering deleteElement .");
		NodeList confitem = doc.getElementsByTagName(CONF_ITEM);
		// Fetch all elements with CONF_ITEM
		for (int i = 0; i < confitem.getLength(); i++) {
			Node node = confitem.item(i);
			if (node.getNodeType() == Document.ELEMENT_NODE) {
				Element confelement = (Element) node;
				NodeList nodeL = confelement.getElementsByTagName(SHORT_NAME);
				// fetch all element with SHORT_NAME
				for (int j = 0; j < nodeL.getLength(); j++) {
					Node node1 = nodeL.item(j);
					Node nodeToDel = node1.getParentNode();
					if (node1.getNodeType() == Document.ELEMENT_NODE && DSM.equalsIgnoreCase(node1.getTextContent())) {
						logger.info("SHORT_NAME with DSM found. Deleting the CONF_ITEM.");
						nodeToDel.getParentNode().removeChild(nodeToDel);
						return true;
					}
				}
			}
		}
		logger.info("Exiting deleteElement .");
		return false;
	}

	private static void initializeLogger(String fileName) {
		try {
			Logger rootLogger = Logger.getRootLogger();
			rootLogger.setLevel(Level.DEBUG);

			PatternLayout layout = new PatternLayout("%d{ISO8601} [%t] %-5p %c %x - %m%n");

			rootLogger.addAppender(new FileAppender(layout, fileName));
			RollingFileAppender fileAppender = new RollingFileAppender(layout, "demoApplication.log");

			rootLogger.addAppender(fileAppender);
		} catch (IOException e) {
			System.out.println("Failed to add appender !!");
		}
	}
}
